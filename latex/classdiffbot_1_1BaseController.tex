\hypertarget{classdiffbot_1_1BaseController}{}\doxysection{diffbot\+::Base\+Controller$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$ Class Template Reference}
\label{classdiffbot_1_1BaseController}\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}


Communicates with the high level hardware\+\_\+interface\+::\+Robot\+HW and interacts with the robot hardware sensors (e.\+g. encoders) and actuators (e.\+g. motor driver).  




{\ttfamily \#include $<$base\+\_\+controller.\+h$>$}



Collaboration diagram for diffbot\+::Base\+Controller$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{classdiffbot_1_1BaseController__coll__graph}
\end{center}
\end{figure}
\doxysubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime}{Last\+Update\+Time}}
\begin{DoxyCompactList}\small\item\em Keeps track of the last update times. \end{DoxyCompactList}\item 
struct \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1UpdateRate}{Update\+Rate}}
\begin{DoxyCompactList}\small\item\em Stores update rate frequencies (Hz) for the main control loop, (optinal) imu and debug output. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classdiffbot_1_1BaseController_a4c57157c3165940f194e85be6aea09a9}{Base\+Controller}} (ros\+::\+Node\+Handle \&\mbox{\hyperlink{test__encoders_8cpp_a8c8f15207982b3e185f86e1b4968e70d}{nh}}, T\+Motor\+Controller $\ast$\mbox{\hyperlink{main_8cpp_a4f09664c28604c52bef0b6974e62d1a9}{motor\+\_\+controller\+\_\+left}}, T\+Motor\+Controller $\ast$\mbox{\hyperlink{main_8cpp_ac36c3751c4beb4c6f24b01eb38332bd8}{motor\+\_\+controller\+\_\+right}})
\begin{DoxyCompactList}\small\item\em Construct a new Base Controller object using two generic motor controllers. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{classdiffbot_1_1BaseController_af5d5dfd7526ef090dfce4d2dbf716fcb}{period}} (double frequency)
\begin{DoxyCompactList}\small\item\em Calculates the period (s) from a given {\ttfamily frequency} (Hz). \end{DoxyCompactList}\item 
\mbox{\hyperlink{structdiffbot_1_1BaseController_1_1UpdateRate}{Update\+Rate}} \& \mbox{\hyperlink{classdiffbot_1_1BaseController_a963c3507de5449f9d4a8451a7a864e5b}{publish\+Rate}} ()
\item 
\mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime}{Last\+Update\+Time}} \& \mbox{\hyperlink{classdiffbot_1_1BaseController_a7dd1945472f83a891dc294daf76b4f47}{last\+Update\+Time}} ()
\begin{DoxyCompactList}\small\item\em Returns a reference to last\+\_\+update\+\_\+times\+\_\+. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{classdiffbot_1_1BaseController_a396de065f1958ceada2110f266ad41d2}{debug}} ()
\begin{DoxyCompactList}\small\item\em Getter if the firmware should log debug output. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a6c8407098d2de3bf7b5b2d8a97293203}{setup}} ()
\begin{DoxyCompactList}\small\item\em Initializes the main node handle and setup publisher and subscriber. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a9add57ee869347d4ee2eeb4e733539fd}{init}} ()
\begin{DoxyCompactList}\small\item\em Reads parameters from the parameter server. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a41354b4d51fc8fb9c97aca6d0d14a446}{e\+Stop}} ()
\begin{DoxyCompactList}\small\item\em Stops the motors, in case no wheel commands are received over a longer time period. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_aac89c2d5c22bdabd9d697dad9a72babb}{read}} ()
\begin{DoxyCompactList}\small\item\em Reads the current encoder tick counts and joint states (angular position (rad) and angular velocity (rad/s) from both encoders left encoder\+\_\+left\+\_\+ and right encoder\+\_\+right\+\_\+ and publishes sensor\+\_\+msgs\+::\+Joint\+State on the \char`\"{}measured\+\_\+joint\+\_\+states\char`\"{} topic, using the pub\+\_\+measured\+\_\+joint\+\_\+states\+\_\+. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a0d178440f5f9ca53ee9a07557db75ffd}{write}} ()
\begin{DoxyCompactList}\small\item\em Uses the P\+I\+Ds to compute capped P\+WM signals for the left and right motor. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a149626e3e16552903f8b53e5c37a0d86}{print\+Debug}} ()
\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a23ae7d9ca0750e9b48b3b037556697a6}{command\+Callback}} (const \mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} \&cmd\+\_\+msg)
\begin{DoxyCompactList}\small\item\em Callback method when a new \mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} is received on the wheel\+\_\+cmd\+\_\+velocities topic. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a9ee08db827f2d8b355ed5592bda44159}{reset\+Encoders\+Callback}} (const std\+\_\+msgs\+::\+Empty \&reset\+\_\+msg)
\begin{DoxyCompactList}\small\item\em Callback method to reset both encoder\textquotesingle{}s tick count to zero. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a001efa473375bc84721d4a4becae6250}{pid\+Left\+Callback}} (const \mbox{\hyperlink{classdiffbot__msgs_1_1PIDStamped}{diffbot\+\_\+msgs\+::\+P\+I\+D\+Stamped}} \&pid\+\_\+msg)
\begin{DoxyCompactList}\small\item\em Callback method to update the \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants for the left motor. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classdiffbot_1_1BaseController_a4c68e722a31b072408c54be82f3c6157}{pid\+Right\+Callback}} (const \mbox{\hyperlink{classdiffbot__msgs_1_1PIDStamped}{diffbot\+\_\+msgs\+::\+P\+I\+D\+Stamped}} \&pid\+\_\+msg)
\begin{DoxyCompactList}\small\item\em Callback method to update the \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants for the right motor. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1UpdateRate}{diffbot\+::\+Base\+Controller\+::\+Update\+Rate}} \mbox{\hyperlink{classdiffbot_1_1BaseController_a0dad88e3a39fd4a5cfa83eef522fa948}{update\+\_\+rate\+\_\+}}
\item 
struct \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime}{diffbot\+::\+Base\+Controller\+::\+Last\+Update\+Time}} \mbox{\hyperlink{classdiffbot_1_1BaseController_a1387b4e876fabe7bee2651f7bde4056e}{last\+\_\+update\+\_\+time\+\_\+}}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\subsubsection*{template$<$typename T\+Motor\+Controller, typename T\+Motor\+Driver$>$\newline
class diffbot\+::\+Base\+Controller$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$}

Communicates with the high level hardware\+\_\+interface\+::\+Robot\+HW and interacts with the robot hardware sensors (e.\+g. encoders) and actuators (e.\+g. motor driver). 

The \mbox{\hyperlink{classdiffbot_1_1BaseController}{Base\+Controller}} communicates with the high level interface diffbot\+\_\+base\+::hardware\+\_\+interface\+::\+Robot\+HW using R\+OS publishers and subscribers. In the main loop (see \mbox{\hyperlink{main_8cpp}{main.\+cpp}}) this class is operated at specific update rates \mbox{\hyperlink{classdiffbot_1_1BaseController_a0dad88e3a39fd4a5cfa83eef522fa948}{update\+\_\+rate\+\_\+}} for different sensors and acutators. There exist three update rates\+:
\begin{DoxyItemize}
\item control
\item imu
\item debug
\end{DoxyItemize}

The control update rate is used to read from the encoders and write computed pwm signals to the motors at a certain rate. This is important to avoid running into syncronization errors because of too many running calculations. Similarly the imu update rate reads the latest inertial measurements at a specific rate. To keep track when a new update is needed, the \mbox{\hyperlink{classdiffbot_1_1BaseController_a1387b4e876fabe7bee2651f7bde4056e}{last\+\_\+update\+\_\+time\+\_\+}} member is used, which stores the time stamps when the last update happened. Additionally the \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime_a315c93513da94a16a851685704014861}{Last\+Update\+Time\+::command\+\_\+received}} time stamp is used to check for connection losses to the high level hardware interface, which would then stop the motors (see \mbox{\hyperlink{classdiffbot_1_1BaseController_a41354b4d51fc8fb9c97aca6d0d14a446}{e\+Stop}}), if no command message was received for a specified amount of time.

The \mbox{\hyperlink{classdiffbot_1_1BaseController}{Base\+Controller}} subscribes to the target wheel command angular velocities (\mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} on the \char`\"{}wheel\+\_\+cmd\+\_\+velocities\char`\"{} topic) with the sub\+\_\+wheel\+\_\+cmd\+\_\+velocities\+\_\+ and keeps pointers to both motors in p\+\_\+motor\+\_\+controller\+\_\+right\+\_\+ and p\+\_\+motor\+\_\+controller\+\_\+left\+\_\+ using a generic motor driver agnostic interface \mbox{\hyperlink{classdiffbot_1_1MotorControllerIntf}{diffbot\+::\+Motor\+Controller\+Intf}}. Each time a new \mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} is received on the \char`\"{}wheel\+\_\+cmd\+\_\+velocities\char`\"{} topic the \mbox{\hyperlink{classdiffbot_1_1BaseController_a23ae7d9ca0750e9b48b3b037556697a6}{command\+Callback}} is called and the two target velocities wheel\+\_\+cmd\+\_\+velocity\+\_\+left\+\_\+ and wheel\+\_\+cmd\+\_\+velocity\+\_\+right\+\_\+ for each wheel are updated.

To measure the angular wheel positions (absolut) and the angular velocities, two \mbox{\hyperlink{classdiffbot_1_1Encoder}{diffbot\+::\+Encoder}} objects (encoder\+\_\+left\+\_\+ encoder\+\_\+right\+\_\+) are used to \mbox{\hyperlink{classdiffbot_1_1BaseController_aac89c2d5c22bdabd9d697dad9a72babb}{read()}} the diffbot\+::\+Joint\+States, stored in joint\+\_\+state\+\_\+left\+\_\+ and joint\+\_\+state\+\_\+left\+\_\+. After reading the latest states (position and velocity), the values are published with pub\+\_\+measured\+\_\+joint\+\_\+states\+\_\+ on \char`\"{}measured\+\_\+joint\+\_\+states\char`\"{} topic of type sensor\+\_\+msgs\+::\+Joint\+State. The diffbot\+\_\+base\+::hardware\+\_\+interface\+::\+Robot\+HW subscribes to these joint states and passes them on to the diff\+\_\+drive\+\_\+controller. Also inside the \mbox{\hyperlink{classdiffbot_1_1BaseController_aac89c2d5c22bdabd9d697dad9a72babb}{read()}} method, the current encoder ticks read from the encoder\+\_\+left\+\_\+ and encoder\+\_\+right\+\_\+ and stored in ticks\+\_\+left\+\_\+ and ticks\+\_\+right\+\_\+.

The measured angular velocities are important to compute the pwm signals for each motor using two separate \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} controllers (motor\+\_\+pid\+\_\+left\+\_\+ and motor\+\_\+pid\+\_\+right\+\_\+), which calculate the error between measured and commanded angular wheel velocity for each wheel joint.

For initialization the following parameters are read from the R\+OS parameter server.
\begin{DoxyItemize}
\item /diffbot/encoder\+\_\+resolution
\item /diffbot/mobile\+\_\+base\+\_\+controller/wheel\+\_\+radius
\item /diffbot/mobile\+\_\+base\+\_\+controller/linear/x/max\+\_\+velocity
\item /diffbot/debug/base\+\_\+controller
\end{DoxyItemize}


\begin{DoxyTemplParams}{Template Parameters}
{\em T\+Motor\+Controller} & \\
\hline
{\em T\+Motor\+Driver} & \\
\hline
\end{DoxyTemplParams}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a4c57157c3165940f194e85be6aea09a9}\label{classdiffbot_1_1BaseController_a4c57157c3165940f194e85be6aea09a9}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!BaseController@{BaseController}}
\index{BaseController@{BaseController}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{BaseController()}{BaseController()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
\mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::\mbox{\hyperlink{classdiffbot_1_1BaseController}{Base\+Controller}} (\begin{DoxyParamCaption}\item[{ros\+::\+Node\+Handle \&}]{nh,  }\item[{T\+Motor\+Controller $\ast$}]{motor\+\_\+controller\+\_\+left,  }\item[{T\+Motor\+Controller $\ast$}]{motor\+\_\+controller\+\_\+right }\end{DoxyParamCaption})}



Construct a new Base Controller object using two generic motor controllers. 

Requires two initialized generic motor controllers, which are defined in a parent scope (e.\+g. \mbox{\hyperlink{main_8cpp}{main.\+cpp}}) The two motor controllers for the left and right motor are kept generic. The only requirement is to implement the \mbox{\hyperlink{classdiffbot_1_1MotorControllerIntf}{diffbot\+::\+Motor\+Controller\+Intf}}, which is composed of the motor driver and has therefore the ability to control one motor.


\begin{DoxyParams}{Parameters}
{\em nh} & Reference to the global R\+OS node handle \\
\hline
{\em motor\+\_\+controller\+\_\+left} & Pointer to the generic motor controller for the left motor \\
\hline
{\em motor\+\_\+controller\+\_\+right} & Pointer to the generic motor controller for the right motor \\
\hline
\end{DoxyParams}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a23ae7d9ca0750e9b48b3b037556697a6}\label{classdiffbot_1_1BaseController_a23ae7d9ca0750e9b48b3b037556697a6}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!commandCallback@{commandCallback}}
\index{commandCallback@{commandCallback}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{commandCallback()}{commandCallback()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::command\+Callback (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} \&}]{cmd\+\_\+msg }\end{DoxyParamCaption})}



Callback method when a new \mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} is received on the wheel\+\_\+cmd\+\_\+velocities topic. 

Callback method every time the angular wheel commands for each wheel joint are received from \textquotesingle{}wheel\+\_\+cmd\+\_\+velocities\textquotesingle{} topic. This topic is published from the high level hardware\+\_\+interface\+::\+Robot\+H\+W\+::write() method.

This callback method receives \mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} message object ({\ttfamily cmd\+\_\+msg}) consisting of \mbox{\hyperlink{classdiffbot__msgs_1_1AngularVelocities}{diffbot\+\_\+msgs\+::\+Angular\+Velocities}}, where commanded wheel joints for the left and right wheel are stored. After receiving the message the wheel\+\_\+cmd\+\_\+velocity\+\_\+left\+\_\+ and wheel\+\_\+cmd\+\_\+velocity\+\_\+right\+\_\+ members are updated, which are used in the next \mbox{\hyperlink{classdiffbot_1_1BaseController_a0d178440f5f9ca53ee9a07557db75ffd}{write()}} of the control loop.


\begin{DoxyCode}{0}
\DoxyCodeLine{wheel\_cmd\_velocity\_left\_ = cmd\_msg.wheels\_cmd.angular\_velocities.joint[0];}
\DoxyCodeLine{wheel\_cmd\_velocity\_right\_ = cmd\_msg.wheels\_cmd.angular\_velocities.joint[1];}
\end{DoxyCode}


In this method the last\+Update\+Time\+::command\+\_\+received time stamp is set to the current time. This is used for the e\+Stop functionality. In case no \mbox{\hyperlink{classdiffbot__msgs_1_1WheelsCmdStamped}{diffbot\+\_\+msgs\+::\+Wheels\+Cmd\+Stamped}} messages are received on the wheel\+\_\+cmd\+\_\+velocities topic, the e\+Stop method is called (see main loop in \mbox{\hyperlink{main_8cpp}{main.\+cpp}})


\begin{DoxyParams}{Parameters}
{\em cmd\+\_\+msg} & Message containing the commanded wheel velocities. \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a396de065f1958ceada2110f266ad41d2}\label{classdiffbot_1_1BaseController_a396de065f1958ceada2110f266ad41d2}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!debug@{debug}}
\index{debug@{debug}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{debug()}{debug()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
bool \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::debug (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Getter if the firmware should log debug output. 

\begin{DoxyReturn}{Returns}
true 

false 
\end{DoxyReturn}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a41354b4d51fc8fb9c97aca6d0d14a446}\label{classdiffbot_1_1BaseController_a41354b4d51fc8fb9c97aca6d0d14a446}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!eStop@{eStop}}
\index{eStop@{eStop}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{eStop()}{eStop()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::e\+Stop}



Stops the motors, in case no wheel commands are received over a longer time period. 

Sets the wheel\+\_\+cmd\+\_\+velocity\+\_\+left\+\_\+ and wheel\+\_\+cmd\+\_\+velocity\+\_\+right\+\_\+ to zero. This method is called when the \mbox{\hyperlink{classdiffbot_1_1BaseController_a23ae7d9ca0750e9b48b3b037556697a6}{command\+Callback}} wasn\textquotesingle{}t called within the \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime_a315c93513da94a16a851685704014861}{Last\+Update\+Time\+::command\+\_\+received}} period on the /diffbot/wheel\+\_\+cmd\+\_\+velocities topic. \mbox{\Hypertarget{classdiffbot_1_1BaseController_a9add57ee869347d4ee2eeb4e733539fd}\label{classdiffbot_1_1BaseController_a9add57ee869347d4ee2eeb4e733539fd}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!init@{init}}
\index{init@{init}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{init()}{init()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::init}



Reads parameters from the parameter server. 


\begin{DoxyItemize}
\item Get Parameters from Parameter Server
\begin{DoxyItemize}
\item /diffbot/encoder\+\_\+resolution
\item /diffbot/mobile\+\_\+base\+\_\+controller/wheel\+\_\+radius
\item /diffbot/mobile\+\_\+base\+\_\+controller/linear/x/max\+\_\+velocity
\item /diffbot/debug/base\+\_\+controller
\end{DoxyItemize}
\item Initialize Diff\+Bot Wheel Encoders
\item Reset both wheel encoders tick count to zero
\item Initialize the max\+\_\+angular\+\_\+velocity\+\_\+ from the read max\+\_\+linear\+\_\+velocity\+\_\+ and wheel\+\_\+radius\+\_\+ 
\end{DoxyItemize}\mbox{\Hypertarget{classdiffbot_1_1BaseController_a7dd1945472f83a891dc294daf76b4f47}\label{classdiffbot_1_1BaseController_a7dd1945472f83a891dc294daf76b4f47}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!lastUpdateTime@{lastUpdateTime}}
\index{lastUpdateTime@{lastUpdateTime}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{lastUpdateTime()}{lastUpdateTime()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
\mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime}{Last\+Update\+Time}}\& \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::last\+Update\+Time (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Returns a reference to last\+\_\+update\+\_\+times\+\_\+. 

Used inside the main loop inside \mbox{\hyperlink{main_8cpp}{main.\+cpp}} to compare with the current time if an update of a specific function (command\+\_\+received, control, imu, debug) is needed.

\begin{DoxyReturn}{Returns}
\mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime}{Last\+Update\+Time}}\& The pervious update times. 
\end{DoxyReturn}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_af5d5dfd7526ef090dfce4d2dbf716fcb}\label{classdiffbot_1_1BaseController_af5d5dfd7526ef090dfce4d2dbf716fcb}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!period@{period}}
\index{period@{period}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{period()}{period()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
int \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::period (\begin{DoxyParamCaption}\item[{double}]{frequency }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Calculates the period (s) from a given {\ttfamily frequency} (Hz). 


\begin{DoxyParams}{Parameters}
{\em frequency} & Input frequency (Hz) to be converted to period. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
int period in seconds. 
\end{DoxyReturn}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a001efa473375bc84721d4a4becae6250}\label{classdiffbot_1_1BaseController_a001efa473375bc84721d4a4becae6250}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!pidLeftCallback@{pidLeftCallback}}
\index{pidLeftCallback@{pidLeftCallback}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{pidLeftCallback()}{pidLeftCallback()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::pid\+Left\+Callback (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{classdiffbot__msgs_1_1PIDStamped}{diffbot\+\_\+msgs\+::\+P\+I\+D\+Stamped}} \&}]{pid\+\_\+msg }\end{DoxyParamCaption})}



Callback method to update the \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants for the left motor. 

Publish to pid\+\_\+left topic to update the \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants of the left motor.


\begin{DoxyParams}{Parameters}
{\em pid\+\_\+msg} & message containing the new \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a4c68e722a31b072408c54be82f3c6157}\label{classdiffbot_1_1BaseController_a4c68e722a31b072408c54be82f3c6157}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!pidRightCallback@{pidRightCallback}}
\index{pidRightCallback@{pidRightCallback}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{pidRightCallback()}{pidRightCallback()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::pid\+Right\+Callback (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{classdiffbot__msgs_1_1PIDStamped}{diffbot\+\_\+msgs\+::\+P\+I\+D\+Stamped}} \&}]{pid\+\_\+msg }\end{DoxyParamCaption})}



Callback method to update the \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants for the right motor. 

Publish to pid\+\_\+right topic to update the \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants of the right motor.


\begin{DoxyParams}{Parameters}
{\em pid\+\_\+msg} & message containing the new \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} constants \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a149626e3e16552903f8b53e5c37a0d86}\label{classdiffbot_1_1BaseController_a149626e3e16552903f8b53e5c37a0d86}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!printDebug@{printDebug}}
\index{printDebug@{printDebug}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{printDebug()}{printDebug()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::print\+Debug}

\mbox{\Hypertarget{classdiffbot_1_1BaseController_a963c3507de5449f9d4a8451a7a864e5b}\label{classdiffbot_1_1BaseController_a963c3507de5449f9d4a8451a7a864e5b}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!publishRate@{publishRate}}
\index{publishRate@{publishRate}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{publishRate()}{publishRate()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
\mbox{\hyperlink{structdiffbot_1_1BaseController_1_1UpdateRate}{Update\+Rate}}\& \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::publish\+Rate (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}

\mbox{\Hypertarget{classdiffbot_1_1BaseController_aac89c2d5c22bdabd9d697dad9a72babb}\label{classdiffbot_1_1BaseController_aac89c2d5c22bdabd9d697dad9a72babb}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!read@{read}}
\index{read@{read}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{read()}{read()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::read}



Reads the current encoder tick counts and joint states (angular position (rad) and angular velocity (rad/s) from both encoders left encoder\+\_\+left\+\_\+ and right encoder\+\_\+right\+\_\+ and publishes sensor\+\_\+msgs\+::\+Joint\+State on the \char`\"{}measured\+\_\+joint\+\_\+states\char`\"{} topic, using the pub\+\_\+measured\+\_\+joint\+\_\+states\+\_\+. 

\mbox{\Hypertarget{classdiffbot_1_1BaseController_a9ee08db827f2d8b355ed5592bda44159}\label{classdiffbot_1_1BaseController_a9ee08db827f2d8b355ed5592bda44159}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!resetEncodersCallback@{resetEncodersCallback}}
\index{resetEncodersCallback@{resetEncodersCallback}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{resetEncodersCallback()}{resetEncodersCallback()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::reset\+Encoders\+Callback (\begin{DoxyParamCaption}\item[{const std\+\_\+msgs\+::\+Empty \&}]{reset\+\_\+msg }\end{DoxyParamCaption})}



Callback method to reset both encoder\textquotesingle{}s tick count to zero. 

For initializing the the \mbox{\hyperlink{classdiffbot_1_1BaseController}{Base\+Controller}} the encoder tick counts are set back to zero. Every time the diffbot\+\_\+bringup/launch/bringup.\+launch is launched, the high level hardware\+\_\+interface\+::\+Robot\+HW publishes an empty message on the /reset topic, which invokes this callback and sets the encoders to zero.


\begin{DoxyParams}{Parameters}
{\em reset\+\_\+msg} & empty message (unused) \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a6c8407098d2de3bf7b5b2d8a97293203}\label{classdiffbot_1_1BaseController_a6c8407098d2de3bf7b5b2d8a97293203}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!setup@{setup}}
\index{setup@{setup}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{setup()}{setup()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::setup}



Initializes the main node handle and setup publisher and subscriber. 

Waits until the connection to the ros master is established. \mbox{\Hypertarget{classdiffbot_1_1BaseController_a0d178440f5f9ca53ee9a07557db75ffd}\label{classdiffbot_1_1BaseController_a0d178440f5f9ca53ee9a07557db75ffd}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!write@{write}}
\index{write@{write}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{write()}{write()}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
void \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::write}



Uses the P\+I\+Ds to compute capped P\+WM signals for the left and right motor. 

The values for both motors sent to the motor driver are calculated by the two P\+I\+Ds pid\+\_\+motor\+\_\+left\+\_\+ and pid\+\_\+motor\+\_\+right\+\_\+, based on the error between commanded angular velocity vs measured angular velocity (e.\+g. diffbot\+::\+P\+I\+D\+::error\+\_\+ = wheel\+\_\+cmd\+\_\+velocity\+\_\+left\+\_\+ -\/ measured\+\_\+angular\+\_\+velocity\+\_\+left\+\_\+)

The calculated \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} ouput values are capped at -\//+ M\+A\+X\+\_\+\+R\+PM to prevent the \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} from having too much error The computed and capped \mbox{\hyperlink{classdiffbot_1_1PID}{P\+ID}} values are then set using the \mbox{\hyperlink{classdiffbot_1_1MotorControllerIntf_aa0e7ffdbb5e4bcb546059ca4a73c9f54}{diffbot\+::\+Motor\+Controller\+Intf\+::set\+Speed}} method for the left and right motors p\+\_\+motor\+\_\+controller\+\_\+left\+\_\+ and p\+\_\+motor\+\_\+controller\+\_\+right\+\_\+. 

\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{classdiffbot_1_1BaseController_a1387b4e876fabe7bee2651f7bde4056e}\label{classdiffbot_1_1BaseController_a1387b4e876fabe7bee2651f7bde4056e}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!last\_update\_time\_@{last\_update\_time\_}}
\index{last\_update\_time\_@{last\_update\_time\_}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{last\_update\_time\_}{last\_update\_time\_}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
struct \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1LastUpdateTime}{diffbot\+::\+Base\+Controller\+::\+Last\+Update\+Time}} \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::last\+\_\+update\+\_\+time\+\_\+}

\mbox{\Hypertarget{classdiffbot_1_1BaseController_a0dad88e3a39fd4a5cfa83eef522fa948}\label{classdiffbot_1_1BaseController_a0dad88e3a39fd4a5cfa83eef522fa948}} 
\index{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}!update\_rate\_@{update\_rate\_}}
\index{update\_rate\_@{update\_rate\_}!diffbot::BaseController$<$ TMotorController, TMotorDriver $>$@{diffbot::BaseController$<$ TMotorController, TMotorDriver $>$}}
\doxysubsubsection{\texorpdfstring{update\_rate\_}{update\_rate\_}}
{\footnotesize\ttfamily template$<$typename T\+Motor\+Controller , typename T\+Motor\+Driver $>$ \\
struct \mbox{\hyperlink{structdiffbot_1_1BaseController_1_1UpdateRate}{diffbot\+::\+Base\+Controller\+::\+Update\+Rate}} \mbox{\hyperlink{classdiffbot_1_1BaseController}{diffbot\+::\+Base\+Controller}}$<$ T\+Motor\+Controller, T\+Motor\+Driver $>$\+::update\+\_\+rate\+\_\+}



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
diffbot\+\_\+base/scripts/base\+\_\+controller/lib/base\+\_\+controller/\mbox{\hyperlink{base__controller_8h}{base\+\_\+controller.\+h}}\end{DoxyCompactItemize}
